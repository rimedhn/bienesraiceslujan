<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESTADO DE CUENTA - CLIENTE</title>
  <link rel="icon" href="https://github.com/rimedhn/bienesraiceslujan/blob/main/Logo%20Bienes%20Raices%20Lujan.png?raw=true" type="image/x-icon">
  <style>
    body { font-family: Arial, sans-serif; background: #fff; padding: 0; margin: 0; }
    .estado-cuenta-container { width: 8in; margin: auto; background: #fff; min-height: 10in; padding: 0.6in 0.5in; position: relative; }
    .header-logo-table { width: 100%; border: none; }
    .logo-img { width: 82px; height: 82px; object-fit: contain; }
    .empresa { font-size: 23px; font-weight: bold; letter-spacing: 1px; }
    .empresa-info { font-size: 13px; color: #333; }
    h2, .seccion-titulo { font-size: 18px; font-weight: bold; margin:15px 0 6px 0; text-align: left; }
    .datos-basicos { margin:10px 0 8px 0; font-size: 16px; }
    .desc-lote-table { width: 100%; font-size: 15px; margin-top: 6px; border:none; }
    .desc-lote-table td { border: none; background: #fff; padding:2px 4px;}
    .cuota-saldo-area { width:100%; display:flex; flex-direction: column; align-items: flex-end; margin-bottom:5px; margin-top:6px;}
    .cuota-line { font-size: 16px; font-weight: bold; color: #1D70B7; padding-bottom:2px;}
    .saldo-inicial {font-size:16px; font-weight:bold; color:#d77f00;}
    .pagos-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 0px; }
    .pagos-table th, .pagos-table td { padding: 3px 6px; border: 1px solid #222; text-align: right;}
    .pagos-table th { background: #f4f4f4; }
    .pagos-table tbody tr:nth-child(even) { background: #fafafa; }
    .pagos-table td.izq, .pagos-table th.izq { text-align: left; }
    .pagos-table td.cuota-nivelada, .pagos-table th.cuota-nivelada { background: #ffe385; font-weight: bold; }
    .pagos-table td.saldo-actual { font-weight: bold; color: #e01313; background: #ffe385; }
    .monto-letras { text-align: left; font-weight: bold; font-size: 15px; margin: 3px 0 5px 0; }
    @media print {
      body, .estado-cuenta-container { background: #fff !important; }
      .estado-cuenta-container { page-break-after: always; }
      .fecha-contrato { color: #e01313 !important;}
    }
  </style>
</head>
<body>
  <div class="estado-cuenta-container">
    <table class="header-logo-table">
      <tr>
        <td style="width:100px;vertical-align:top;">
          <img class="logo-img" src="https://github.com/rimedhn/bienesraiceslujan/blob/main/Logo%20Corto%20Bienes%20Raices%20Lujan.jpeg?raw=true" alt="Logo" />
        </td>
        <td>
          <div class="empresa">BIENES RAICES LUJÁN</div>
          <div class="empresa-info">RTN. 01011981030771</div>
          <div class="empresa-info">Barrio Nuevo, Calle principal, Plaza Roland.</div>
          <div class="empresa-info">bienesraiceslujan@live.com Teléfonos: +504 9739-5260</div>
        </td>
      </tr>
    </table>
    <hr>
    <h2>ESTADO DE CUENTA</h2>
    <div class="datos-basicos">
      <span><b>Cliente/Estipulante:</b> <span id="NombreCliente"></span></span><br>
      <span><b>Comprador(es):</b> <span id="NombreComprador"></span></span>
    </div>
    <div class="seccion-titulo">DESCRIPCIÓN DEL LOTE / PRÉSTAMO</div>
    <table class="desc-lote-table">
      <tr>
        <td><b>Lotificación:</b> <span id="NombreLotificacion"></span></td>
        <td><b>Número de lote:</b> <span id="NoLoteybloque"></span></td>
      </tr>
      <tr>
        <td><b>Valor del terreno:</b> L<span id="Monto"></span></td>
        <td><b>Valor de la Prima:</b> L<span id="Prima"></span></td>
      </tr>
      <tr>
        <td colspan="2"><b>Valor Financiado:</b> L<span id="Financiado"></span></td>
      </tr>
      <tr>
        <td colspan="2">
          <b>Plazo de financiamiento:</b> <span id="PlazoLetras"></span>
        </td>
      </tr>
      <tr>
        <td colspan="2"><b>Fecha del contrato:</b> <span class="fecha-contrato" id="FechaAprobado"></span></td>
      </tr>
    </table>
    <div class="seccion-titulo" style="margin-top:20px;">Detalle de pagos</div>
    <div class="cuota-saldo-area">
      <div class="cuota-line">CUOTA NIVELADA MENSUAL: <span id="CuotaNiveladaCalculo"></span></div>
      <div class="saldo-inicial">SALDO INICIAL: <span id="SaldoInicial"></span></div>
    </div>
    <table class="pagos-table" id="pagosTable">
      <thead>
        <tr>
          <th class="izq">Fecha</th>
          <th>Mes</th>
          <th>Pago</th>
          <th>No.</th>
          <th>Capital</th>
          <th>Interés</th>
          <th>Cuota</th>
          <th>Mora 3%</th>
          <th>Abono Capital</th>
          <th class="saldo-actual">Saldo Actual</th>
        </tr>
      </thead>
      <tbody id="detallePagosBody"></tbody>
    </table>
  </div>
  <script>
    // URLs de datos y parámetros
    const openSheetPrestamo = "https://opensheet.elk.sh/1btdSW67kQkSbKRo8PszEGqOwlA6c7o8gi-gSLdT93hE/Prestamo";
    const openSheetAbono = "https://opensheet.elk.sh/1btdSW67kQkSbKRo8PszEGqOwlA6c7o8gi-gSLdT93hE/Abono prestamo";
    function getQueryParam(param) {
      var urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    function fetchJSON(url){ return fetch(url).then(r=>r.json()); }
    function formatCurrency(num){ if(isNaN(num))return "L 0.00"; return "L "+parseFloat(num).toLocaleString('es-HN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function parseNumber(val){ val=(""+val).replace("L","").replace("$","").replace(",","").trim(); return parseFloat(val)||0; }
    function formatFecha(fechaStr){
      if(!fechaStr)return "";
      let d=new Date(fechaStr);
      if (isNaN(d.getTime())) return fechaStr;
      let dd = d.getDate()>9?d.getDate():"0"+d.getDate();
      let mm = (d.getMonth()+1)>9?(d.getMonth()+1):"0"+(d.getMonth()+1);
      let yyyy=d.getFullYear();
      return dd+"/"+mm+"/"+yyyy;
    }
    // Cálculo de cuota nivelada mensual (anualidad)
    function calcularCuotaNivelada(principal, tasa, plazo){
      if(principal <= 0 || plazo <= 0) return 0;
      let tasaDecimal = parseFloat(tasa)/100;
      if(isNaN(tasaDecimal) || tasaDecimal==0) return principal/plazo;
      // cuota = P * (r(1+r)^n) / ((1+r)^n - 1)
      let r = tasaDecimal;
      let n = plazo;
      let cuota = principal * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n)-1);
      return cuota;
    }
    // Cálculo de número de mes desde la fecha inicial, retorna formato n/aaaa
    function calcularMesSecuencial(fechaInicial, fechaPago) {
      let fi = new Date(fechaInicial);
      let fp = new Date(fechaPago);
      if (isNaN(fi.getTime()) || isNaN(fp.getTime())) return "";
      let diffMonths = (fp.getFullYear() - fi.getFullYear()) * 12 + (fp.getMonth() - fi.getMonth());
      let mesSecuencia = diffMonths + 1; // mes 1 corresponde a la fecha inicial
      return mesSecuencia + "/" + fp.getFullYear();
    }
    async function loadEstadoCuenta() {
      let idprestamo = getQueryParam('idprestamo');
      if (!idprestamo) { alert("Falta el parámetro idprestamo."); return; }
      let [prestamos, abonos] = await Promise.all([
        fetchJSON(openSheetPrestamo),
        fetchJSON(openSheetAbono)
      ]);
      let prestamo = prestamos.find(p => p.idprestamo == idprestamo);
      if (!prestamo) { alert("Préstamo no encontrado."); return; }

      // Extracción y cálculo de valores
      let monto = parseNumber(prestamo.Monto);
      let prima = parseNumber(prestamo.Prima);
      let valorFinanciado = monto - prima;
      let plazo = parseInt(prestamo.Plazo);
      let tasa = parseNumber(prestamo.Tasa);
      let cuotaNivelada = calcularCuotaNivelada(valorFinanciado, tasa, plazo);

      document.getElementById("NombreCliente").textContent = prestamo.NombreCliente || "";
      document.getElementById("NombreComprador").textContent = prestamo.NombreComprador || "";
      document.getElementById("NombreLotificacion").textContent = prestamo.NombreLotificacion || "";
      document.getElementById("NoLoteybloque").textContent = prestamo.NoLoteybloque || "";
      document.getElementById("Monto").textContent = monto.toFixed(2);
      document.getElementById("Prima").textContent = prima.toFixed(2);
      document.getElementById("Financiado").textContent = valorFinanciado.toFixed(2);
      document.getElementById("PlazoLetras").textContent = (prestamo.Plazo ? prestamo.Plazo + " Meses" : "");
      document.getElementById("FechaAprobado").textContent = formatFecha(prestamo.FechaAprobado);

      // Mostrar cuota y saldo inicial juntos arriba de tabla de pagos
      document.getElementById("CuotaNiveladaCalculo").textContent = formatCurrency(cuotaNivelada);
      document.getElementById("SaldoInicial").textContent = formatCurrency(valorFinanciado);

      let abonosPrestamo = abonos
        .filter(a => a.Prestamo == idprestamo)
        .sort((a, b) => {
          // Ordenar por Fecha de pago si existe, sino por Fecha
          let fa = new Date(a["Fecha de pago"] || a.Fecha || 0);
          let fb = new Date(b["Fecha de pago"] || b.Fecha || 0);
          return fa - fb;
        });

      let saldoActual = valorFinanciado;
      let tbody = document.getElementById("detallePagosBody");
      tbody.innerHTML = "";

      let fechaAprobado = prestamo.FechaAprobado;
      for (let idx = 0; idx < abonosPrestamo.length; ++idx) {
        let ab = abonosPrestamo[idx];
        let fechaPago = ab["Fecha de pago"] || ab.Fecha;
        let mesSecuencia = calcularMesSecuencial(fechaAprobado, fechaPago);
        let fecha = formatFecha(fechaPago);
        let pago = parseNumber(ab.Monto);
        let capital = parseNumber(ab.Capital);
        let interes = ab.Interes ? parseNumber(ab.Interes) : 0;
        let cuota = ab.Cuota ? parseNumber(ab.Cuota) : 0;
        let mora = ab.Recargo ? parseNumber(ab.Recargo) : 0;
        let abonoCapital = ab["Abono capital"] ? parseNumber(ab["Abono capital"]) : 0;
        let noCuota = ab["No cuota"] || (idx + 1);

        saldoActual -= capital + abonoCapital;

        let fila = tbody.insertRow(-1);
        fila.insertCell().className = "izq"; fila.cells[0].textContent = fecha;
        fila.insertCell().textContent = mesSecuencia; // Mes calculado desde fecha inicial
        fila.insertCell().textContent = formatCurrency(pago);
        fila.insertCell().textContent = noCuota;
        fila.insertCell().textContent = formatCurrency(capital);
        fila.insertCell().textContent = formatCurrency(interes);
        fila.insertCell().textContent = formatCurrency(cuota);
        fila.insertCell().textContent = formatCurrency(mora);
        fila.insertCell().textContent = formatCurrency(abonoCapital);
        fila.insertCell().className = "saldo-actual"; fila.cells[9].textContent = formatCurrency(saldoActual);
      }
      if(abonosPrestamo.length===0){
        let fila = tbody.insertRow(0);
        for(let c=0;c<9;c++) fila.insertCell().textContent = '';
        fila.insertCell().className = "saldo-actual"; fila.cells[9].textContent = formatCurrency(saldoActual);
      }
      setTimeout(function(){window.print();},600);
    }
    window.onload = loadEstadoCuenta;
  </script>
</body>
</html>

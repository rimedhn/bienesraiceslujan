<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONTRATO DE PROMESA DE VENTA</title>
  <style>
    /* Global typography */
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 30px;
      -webkit-print-color-adjust: exact;
      background: #f2f4f7;
    }

    /* Container for the main contract text - styled like a document */
    #content {
      max-width: 820px;
      margin: 0 auto;
      background: #ffffff;
      padding: 28px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      border: 1px solid #e0e4ea;
      text-align: justify;
      line-height: 1.5;
      white-space: pre-wrap;
      color: #111;
    }

    /* Title styling: centered and bold */
    .title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 12px;
      font-size: 20px; /* aumentado según solicitud */
      letter-spacing: 0.6px;
    }

    /* Inline field placeholders */
    [data-field] {
      /* default normal weight; specific fields will be rendered bold by the script when needed */
    }

    /* Bold enumerators style (in case script wraps them) */
    .enumerator { font-weight: bold; }

    /* Signature layout */
    .signatures-top {
      display: flex;
      justify-content: space-between;
      margin-top: 28px;
      gap: 10px;
    }

    .sig {
      width: 48%;
      text-align: center;
    }

    .sig .hrline {
      border-top: 1px solid #000;
      height: 1px;
      margin-top: 28px;
    }

    .sig .name {
      margin-top: 6px;
      font-weight: bold;
    }

    .sig .role {
      margin-top: 2px;
    }

    /* Buyers signatures: centered blocks, one per buyer */
    #buyers {
      margin-top: 22px;
    }

    .buyer-block {
      text-align: center;
      margin-top: 18px;
      page-break-inside: avoid;
    }

    .buyer-block .hrline {
      border-top: 1px solid #000;
      width: 60%;
      margin: 18px auto 8px auto;
      height: 1px;
    }

    .buyer-block .buyer-name {
      font-weight: bold;
      margin-top: 4px;
      text-transform: uppercase; /* refuerzo visual */
    }

    .buyer-block .buyer-role {
      margin-top: 2px;
      font-style: normal;
    }

    /* Prevent signature blocks from collapsing at page breaks */
    .sig, .buyer-block { break-inside: avoid; }

    /* Print adjustments */
    @media print {
      body { margin: 10mm; background: #fff; }
      #content { box-shadow: none; border: none; margin: 0; padding: 0; }
    }
  </style>
</head>
<body>
  <div id="content">
    <div class="title">CONTRATO DE PROMESA DE VENTA</div>

NOSOTROS: <span data-field="Representante">&lt;&lt;Representante&gt;&gt;</span>, <span data-field="Datosrepresentante">&lt;&lt;Datosrepresentante&gt;&gt;</span> <span data-field="NombreEmpresa">&lt;&lt;NombreEmpresa&gt;&gt;</span> <span data-field="DatosInstrumento">&lt;&lt;DatosInstrumento&gt;&gt;</span> <span data-field="DatosNotario">&lt;&lt;DatosNotario&gt;&gt;</span>
En la ciudad de La Ceiba, departamento de Atlántida a los <span data-field="FechaLetras">&lt;&lt;FechaLetras&gt;&gt;</span>
  </div>

  <!-- Signatures: Gerente (left) and Estipulante (right) side by side -->
  <div class="signatures-top">
    <div class="sig" id="sig-representante">
      <div class="hrline"></div>
      <div class="name" data-field="Representante">&lt;&lt;Representante&gt;&gt;</div>
      <div class="role">GERENTE</div>
    </div>

    <div class="sig" id="sig-estipulante">
      <div class="hrline"></div>
      <div class="name" data-field="FirmaEstipulanteContrato">&lt;&lt;FirmaEstipulanteContrato&gt;&gt;</div>
      <div class="role">ESTIPULANTE</div>
    </div>
  </div>

  <!-- Buyers signatures: one line and name for each buyer, and indicate role from ProminenteComprador -->
  <div id="buyers"></div>

  <script>
    // List of all fields present between <<[ ... ]>> in the document
    var FIELD_NAMES = [
      "Representante","Datosrepresentante","NombreEmpresa","DatosInstrumento","DatosNotario",
      "DatoCompradorContrato","DatosLotificacionContrato","IdentificacionLotesVentaContrato","DatosLotesVentaContrato",
      "AlProminenteComprador","ElLosLotesDesccritos","QuienLoReciben","MontoLetras","Monto",
      "PrimaLetras","Prima","FinanciadoLetras","Financiado","CuotaLetras","Cuota",
      "PlazoLetras","RecargoLetras","RecargoApp","DatosCompradorFinalContrato","FechaLetras",
      "FirmaEstipulanteContrato","NombreCompradores","ProminenteComprador","ElProminenteComprador"
    ];

    // Fields to make bold (names, montos y cantidades)
    var BOLD_FIELDS = [
      "Representante","NombreEmpresa","DatosNotario",
      "DatoCompradorContrato","DatosLotificacionContrato","IdentificacionLotesVentaContrato","DatosLotesVentaContrato",
      "AlProminenteComprador","MontoLetras","Monto",
      "PrimaLetras","Prima","FinanciadoLetras","Financiado","CuotaLetras","Cuota",
      "PlazoLetras","RecargoLetras","RecargoApp","DatosCompradorFinalContrato",
      "FirmaEstipulanteContrato","NombreCompradores","ProminenteComprador","ElProminenteComprador"
    ];

    // Return query parameter (decoded)
    function getQueryParam(name) {
      var p = new URLSearchParams(window.location.search);
      return p.get(name) || "";
    }

    // Escape HTML to avoid injections when setting innerHTML
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Fill all elements that contain data-field attributes matching our fields
    function fillFields() {
      FIELD_NAMES.forEach(function(name) {
        var value = getQueryParam(name);
        if (!value) return;
        var els = document.querySelectorAll('[data-field="' + name + '"]');
        els.forEach(function(el){
          var safe = escapeHtml(value);
          if (BOLD_FIELDS.indexOf(name) !== -1) {
            el.innerHTML = "<strong>" + safe + "</strong>";
          } else {
            el.textContent = value;
          }
        });
      });
    }

    // Hide stipulante signature block if FirmaEstipulanteContrato not provided
    function toggleEstipulanteBlock() {
      var val = getQueryParam("FirmaEstipulanteContrato");
      if (!val || val.trim() === "") {
        var el = document.getElementById("sig-estipulante");
        if (el) el.style.display = "none";
        // expand representative to take full width if desired (optional)
        var rep = document.getElementById("sig-representante");
        if (rep) rep.style.width = "100%";
      }
    }

    // Render buyers signatures
    // NombreCompradores: expected list of names separated by commas (e.g. "Juan Pérez, Ana López")
    // ProminenteComprador: text that indicates their role (e.g. "COMPRADOR"), can be a single value or several separated by '|' or commas to match each buyer.
    function renderBuyers() {
      var container = document.getElementById("buyers");
      container.innerHTML = "";

      var rawNames = getQueryParam("NombreCompradores");
      if (!rawNames) return;

      // Split names by comma (allow spaces) or by newline
      var names = rawNames.split(/\s*,\s*|\r?\n/).map(function(s){ return s.trim(); }).filter(function(s){ return s.length>0; });

      var rawRoles = getQueryParam("ProminenteComprador") || "";
      var roles = [];
      if (rawRoles.indexOf("|") !== -1) {
        roles = rawRoles.split("|").map(function(s){ return s.trim(); });
      } else if (rawRoles.indexOf(",") !== -1) {
        roles = rawRoles.split(/\s*,\s*/).map(function(s){ return s.trim(); });
      } else if (rawRoles.trim() !== "") {
        // same role for all buyers
        for (var k=0;k<names.length;k++) roles.push(rawRoles.trim());
      }

      // Ensure roles length matches or default to "COMPRADOR" if empty
      for (var i=0;i<names.length;i++) {
        var name = names[i];
        var role = roles[i] || rawRoles || "COMPRADOR";

        var block = document.createElement("div");
        block.className = "buyer-block";

        // signature line
        var hr = document.createElement("div");
        hr.className = "hrline";
        block.appendChild(hr);

        // buyer name (bold and uppercase)
        var nameEl = document.createElement("div");
        nameEl.className = "buyer-name";
        nameEl.innerHTML = "<strong>" + escapeHtml(name.toUpperCase()) + "</strong>";
        block.appendChild(nameEl);

        // role (ProminenteComprador)
        var roleEl = document.createElement("div");
        roleEl.className = "buyer-role";
        roleEl.textContent = role;
        block.appendChild(roleEl);

        container.appendChild(block);
      }
    }

    // Bold enumerators like "PRIMERO.-", "SEGUNDO.-" and variants (PRIMERA, DÉCIMO PRIMERO, VIGÉSIMO PRIMERO, etc.)
    function boldEnumerators() {
      var container = document.getElementById("content");
      if (!container) return;
      var html = container.innerHTML;

      // Single-word ordinals (including feminine and accented variants)
      var singles = [
        'PRIMERO','PRIMERA','SEGUNDO','SEGUNDA','TERCERO','TERCERA','CUARTO','CUARTA',
        'QUINTO','QUINTA','SEXTO','SEXTA','SEPTIMO','SÉPTIMO','SEPTIMA','SÉPTIMA',
        'OCTAVO','OCTAVA','NOVENO','NOVENA','DECIMO','DÉCIMO','DECIMA','DÉCIMA',
        'UNDECIMO','UNDÉCIMO','UNDECIMA','UNDÉCIMA','DUODÉCIMO','DUODÉCIMA',
        'DECIMOTERCERO','DECIMOTERCERA','DECIMOCUARTO','DECIMOQUINTO','DECIMOSEXTO',
        'DECIMOSEPTIMO','DECIMOOCTAVO','DECIMONOVENO','VIGESIMO','VIGÉSIMO','VIGESIMA','VIGÉSIMA',
        'TRIGESIMO','TRIGÉSIMO'
      ];

      // Prefixes that combine with suffixes to form composite ordinals
      var prefixes = ['DECIMO','DÉCIMO','VIGESIMO','VIGÉSIMO','TRIGESIMO','TRIGÉSIMO'];

      // Common suffixes for composite ordinals
      var suffixes = [
        'PRIMERO','PRIMERA','SEGUNDO','SEGUNDA','TERCERO','TERCERA','CUARTO','CUARTA',
        'QUINTO','QUINTA'
      ];

      // Build composite list (prefix + space or hyphen + suffix)
      var composites = [];
      prefixes.forEach(function(p){
        suffixes.forEach(function(s){
          composites.push(p + '\\s+' + s);   // space separated
          composites.push(p + '-' + s);     // hyphen separated
        });
      });

      // Combine all variants into one alternation group
      var all = singles.concat(prefixes).concat(composites);

      // Escape all elements for regex (they already are uppercase words, but composites have backslashes)
      var regexBody = all.join('|');

      // Regex: match start of line or after newline, optional spaces, the ordinal, then delimiter (. - ) or : and spaces
      var regex = new RegExp('(^|\\n)(\\s*)(' + regexBody + ')(\\s*[\\.\\-\\)\\:]\\s*)', 'gim');

      html = html.replace(regex, function(match, g1, g2, g3, g4){
        return g1 + g2 + '<span class="enumerator">' + g3 + g4 + '</span>';
      });

      container.innerHTML = html;
    }

    // Bold the specific long contractual section described by the user:
    // "Quedando entendido <<ElProminenteComprador>>, que en caso de incumplimiento ... POR CUOTA RETRASADA."
    function boldSpecificSection() {
      var container = document.getElementById("content");
      if (!container) return;
      var html = container.innerHTML;

      // Make a broad replace from "Quedando entendido" up to "POR CUOTA RETRASADA."
      // Use a case-insensitive search and DOTALL-like behavior via [\s\S]*?
      var pattern = /Quedando entendido[\s\S]*?POR CUOTA RETRASADA\./i;
      html = html.replace(pattern, function(m){
        return '<strong>' + m + '</strong>';
      });

      // Replace "LA PROMINENTE VENDEDORA" (case-insensitive) with the requested text and bold it
      html = html.replace(/LA PROMINENTE VENDEDORA/gi, function(){
        return '<strong>EL (LA) PROMINENTE VENDEDOR (A)</strong>';
      });

      container.innerHTML = html;
    }

    // On load: fill fields, render buyer signatures, then open print dialog automatically
    window.onload = function() {
      fillFields();
      renderBuyers();
      toggleEstipulanteBlock();

      // Apply textual transformations after fields are filled
      boldEnumerators();
      boldSpecificSection();

      // Give the browser a very small timeout so rendering completes, then open print dialog
      setTimeout(function(){ window.print(); }, 500);
    };
  </script>
</body>
</html>
